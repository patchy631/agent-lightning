
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://microsoft.github.io/agent-lightning/latest/reference/rl/">
      
      
        <link rel="prev" href="../core/">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>RL - Agent Lightning</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
      <link rel="stylesheet" href="../../css/timeago.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reinforcement-learning-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <div data-md-color-scheme="default" data-md-component="outdated" hidden>
        
      </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Agent Lightning" class="md-header__button md-logo" aria-label="Agent Lightning" data-md-component="logo">
      
  <img src="../../assets/logo-light.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Agent Lightning
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              RL
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="red"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="red" data-md-color-accent="red"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
        <div class="md-search__suggest" data-md-component="search-suggest"></div>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/microsoft/agent-lightning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agent-lightning
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Agent Lightning" class="md-nav__button md-logo" aria-label="Agent Lightning" data-md-component="logo">
      
  <img src="../../assets/logo-light.png" alt="logo">

    </a>
    Agent Lightning
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/microsoft/agent-lightning" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    agent-lightning
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Quickstart
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Quickstart
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Installation
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../quickstart/getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    How-To Guides
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            How-To Guides
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../how-to/train-sql-agent/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Train SQL Agent
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Deep Dive
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Deep Dive
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deep-dive/server-client-architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Server-Client Architecture
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API Reference
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            API Reference
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    RL
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    RL
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#agentlightning.verl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;verl
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" verl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.NamedResources" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;NamedResources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentLightningServer
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AgentLightningServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.get_completed_rollout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_completed_rollout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.poll_completed_rollout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;poll_completed_rollout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.queue_task" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;queue_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.retrieve_completed_rollouts" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;retrieve_completed_rollouts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.run_forever" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run_forever
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.stop" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.update_resources" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;update_resources
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentLightningTrainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentModeDaemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AgentModeDaemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;clear_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_test_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_test_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_train_data_batch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run_until_all_finished
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_up_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.LLM" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LLM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.Rollout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Rollout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_left_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_left_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_right_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_right_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#agentlightning.verl" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-module"></code>&nbsp;verl
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" verl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.NamedResources" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-attribute"></code>&nbsp;NamedResources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentLightningServer
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AgentLightningServer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;__init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.get_completed_rollout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_completed_rollout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.poll_completed_rollout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;poll_completed_rollout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.queue_task" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;queue_task
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.retrieve_completed_rollouts" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;retrieve_completed_rollouts
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.run_forever" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run_forever
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.stop" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;stop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningServer.update_resources" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;update_resources
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentLightningTrainer" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentLightningTrainer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;AgentModeDaemon
    </span>
  </a>
  
    <nav class="md-nav" aria-label=" AgentModeDaemon">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;clear_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_test_metrics" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_test_metrics
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;get_train_data_batch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;run_until_all_finished
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;set_up_data_and_server
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.AgentModeDaemon.start" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-method"></code>&nbsp;start
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.LLM" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;LLM
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.Rollout" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-class"></code>&nbsp;Rollout
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_left_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_left_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#agentlightning.verl.get_right_padded_ids_and_attention_mask" class="md-nav__link">
    <span class="md-ellipsis">
      <code class="doc-symbol doc-symbol-toc doc-symbol-function"></code>&nbsp;get_right_padded_ids_and_attention_mask
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="reinforcement-learning-api">Reinforcement Learning API<a class="headerlink" href="#reinforcement-learning-api" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<h2 id="agentlightning.verl" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-module"></code>            <code>agentlightning.verl</code>


<a href="#agentlightning.verl" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










  <div class="doc doc-children">







<div class="doc doc-object doc-attribute">



<h3 id="agentlightning.verl.NamedResources" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-attribute"></code>            <code class="highlight language-python"><span class="n">NamedResources</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ResourceUnion</span><span class="p">]</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-module-attribute"><code>module-attribute</code></small>
  </span>

<a href="#agentlightning.verl.NamedResources" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>A dictionary-like class to hold named resources.</p>


<details class="example" open>
  <summary>Example</summary>
  <p>resources: NamedResources = {
    'main_llm': LLM(
        endpoint="http://localhost:8080",
        model="llama3",
        sampling_parameters={'temperature': 0.7, 'max_tokens': 100}
    ),
    'system_prompt': PromptTemplate(
        template="You are a helpful assistant.",
        engine='f-string'
    )
}</p>
</details>
    </div>

</div>



<div class="doc doc-object doc-class">



<h3 id="agentlightning.verl.AgentLightningServer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>AgentLightningServer</code>


<a href="#agentlightning.verl.AgentLightningServer" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>The main SDK class for developers to control the Agent Lightning Server.</p>
<p>This class manages the server lifecycle, task queueing, resources updates,
and retrieval of results, providing a simple interface for the optimization logic.</p>








              <details class="quote">
                <summary>Source code in <code>agentlightning/server.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentLightningServer</span><span class="p">:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    The main SDK class for developers to control the Agent Lightning Server.</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    This class manages the server lifecycle, task queueing, resources updates,</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    and retrieval of results, providing a simple interface for the optimization logic.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span> <span class="n">task_timeout_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span><span class="p">):</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        Initializes the server controller.</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">            host: The host to bind the server to.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">            port: The port to bind the server to.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">            task_timeout_seconds: Time in seconds after which a claimed task is considered stale and requeued.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task_timeout_seconds</span> <span class="o">=</span> <span class="n">task_timeout_seconds</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="c1"># Defer initialization and use event for cross-thread communication</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ServerDataStore</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startup_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="c1"># Create FastAPI app instance with a lifespan manager</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lifespan</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_routes</span><span class="p">()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_config</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_config</span><span class="p">)</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>    <span class="c1"># --- ADDED: Lifespan context manager ---</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="nd">@asynccontextmanager</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_lifespan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">:</span> <span class="n">FastAPI</span><span class="p">):</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a><span class="sd">        Manages server startup and shutdown. This runs inside the server&#39;s event loop.</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is starting up...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="n">ServerDataStore</span><span class="p">()</span>  <span class="c1"># Initialize data store here</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>  <span class="c1"># Signal that the server is ready</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">yield</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server is shutting down.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_store</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># Clear the startup event</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_check_and_requeue_stale_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">        Check for stale tasks and requeue them. Called reactively during get_next_task.</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="c1"># Ensure store is initialized before checking</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="k">return</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>        <span class="n">processing_tasks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_processing_tasks</span><span class="p">()</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">task</span> <span class="ow">in</span> <span class="n">processing_tasks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">last_claim_time</span> <span class="ow">and</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">task</span><span class="o">.</span><span class="n">last_claim_time</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_timeout_seconds</span><span class="p">:</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">requeue_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                    <span class="sa">f</span><span class="s2">&quot;Task </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2"> timed out after </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_task_timeout_seconds</span><span class="si">}</span><span class="s2">s, requeued (attempt </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">num_claims</span><span class="si">}</span><span class="s2">)&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_setup_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Setup FastAPI routes.&quot;&quot;&quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/task&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">TaskIfAny</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">next_task</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">TaskIfAny</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Endpoint for clients to poll for the next available task.&quot;&quot;&quot;</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_and_requeue_stale_tasks</span><span class="p">()</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="k">return</span> <span class="n">TaskIfAny</span><span class="p">(</span><span class="n">is_available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="n">task</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_next_task</span><span class="p">()</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="k">if</span> <span class="n">task</span><span class="p">:</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serving task </span><span class="si">{</span><span class="n">task</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2"> to a client.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>                <span class="k">return</span> <span class="n">TaskIfAny</span><span class="p">(</span><span class="n">is_available</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="n">task</span><span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No task available for client.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                <span class="k">return</span> <span class="n">TaskIfAny</span><span class="p">(</span><span class="n">is_available</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/resources/latest&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ResourcesUpdate</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_latest_resources</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">ResourcesUpdate</span><span class="p">:</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Endpoint for clients to poll for the latest available resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Server not fully initialized.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">resources_update</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_latest_resources</span><span class="p">()</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">resources_update</span><span class="p">:</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;No resources have been set on the server.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serving latest resources &#39;</span><span class="si">{</span><span class="n">resources_update</span><span class="o">.</span><span class="n">resources_id</span><span class="si">}</span><span class="s2">&#39; to a client.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="k">return</span> <span class="n">resources_update</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;/resources/</span><span class="si">{resource_id}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">ResourcesUpdate</span><span class="p">)</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">fetch_resources_by_id</span><span class="p">(</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>            <span class="n">resource_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The unique identifier for the resource version.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ResourcesUpdate</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Endpoint for clients to fetch a specific version of resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Server not fully initialized.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">resources_update</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">get_resources_by_id</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">resources_update</span><span class="p">:</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">404</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Resource ID &#39;</span><span class="si">{</span><span class="n">resource_id</span><span class="si">}</span><span class="s2">&#39; not found.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Serving resources for ID &#39;</span><span class="si">{</span><span class="n">resource_id</span><span class="si">}</span><span class="s2">&#39; to a client.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="k">return</span> <span class="n">resources_update</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="nd">@self</span><span class="o">.</span><span class="n">_app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">&quot;/rollout&quot;</span><span class="p">,</span> <span class="n">response_model</span><span class="o">=</span><span class="n">GenericResponse</span><span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">post_rollout</span><span class="p">(</span><span class="n">payload</span><span class="p">:</span> <span class="n">Rollout</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GenericResponse</span><span class="p">:</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Endpoint for clients to report a completed rollout.&quot;&quot;&quot;</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="k">raise</span> <span class="n">HTTPException</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="mi">503</span><span class="p">,</span> <span class="n">detail</span><span class="o">=</span><span class="s2">&quot;Server not fully initialized.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">store_rollout</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="k">return</span> <span class="n">GenericResponse</span><span class="p">(</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="n">status</span><span class="o">=</span><span class="s2">&quot;ok&quot;</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Rollout </span><span class="si">{</span><span class="n">payload</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2"> received and stored.&quot;</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the FastAPI server in the background.&quot;&quot;&quot;</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">serve</span><span class="p">())</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Allow time for server to start up.</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Gracefully stops the running FastAPI server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping server...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">should_exit</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Allow time for graceful shutdown.</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server stopped.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        Runs the server indefinitely until stopped.</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        This is useful when async start and stop methods do not work.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">queue_task</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="n">sample</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="n">resources_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">        Adds a task to the queue for a client to process.</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">resources_id</span><span class="o">=</span><span class="n">resources_id</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="n">NamedResources</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">        Updates the resources, creating a new version and setting it as the latest.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">resources_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;res-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">update</span> <span class="o">=</span> <span class="n">ResourcesUpdate</span><span class="p">(</span><span class="n">resources_id</span><span class="o">=</span><span class="n">resources_id</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">update_resources</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="k">return</span> <span class="n">resources_id</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_completed_rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Rollout</span><span class="p">]:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">        Retrieves a specific completed rollout by its ID.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">retrieve_rollout</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">poll_completed_rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Rollout</span><span class="p">]:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">        Polls for a completed rollout by its ID, waiting up to `timeout` seconds.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>            <span class="n">rollout</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_completed_rollout</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>            <span class="k">if</span> <span class="n">rollout</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                <span class="k">return</span> <span class="n">rollout</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>            <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>                <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retrieve_completed_rollouts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Rollout</span><span class="p">]:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">        Retrieves all available completed trajectories and clears the internal store.</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>        <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">retrieve_completed_rollouts</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.__init__" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">8000</span><span class="p">,</span> <span class="n">task_timeout_seconds</span><span class="o">=</span><span class="mf">300.0</span><span class="p">)</span></code>

<a href="#agentlightning.verl.AgentLightningServer.__init__" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Initializes the server controller.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>host</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The host to bind the server to.</p>
              </div>
            </td>
            <td>
                  <code>&#39;127.0.0.1&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>port</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The port to bind the server to.</p>
              </div>
            </td>
            <td>
                  <code>8000</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>task_timeout_seconds</code>
            </td>
            <td>
                  <code><span title="float">float</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Time in seconds after which a claimed task is considered stale and requeued.</p>
              </div>
            </td>
            <td>
                  <code>300.0</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span> <span class="n">port</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">,</span> <span class="n">task_timeout_seconds</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">300.0</span><span class="p">):</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Initializes the server controller.</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        host: The host to bind the server to.</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        port: The port to bind the server to.</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        task_timeout_seconds: Time in seconds after which a claimed task is considered stale and requeued.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">port</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">host</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">port</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_task_timeout_seconds</span> <span class="o">=</span> <span class="n">task_timeout_seconds</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="c1"># Defer initialization and use event for cross-thread communication</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ServerDataStore</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">startup_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="c1"># Create FastAPI app instance with a lifespan manager</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_app</span> <span class="o">=</span> <span class="n">FastAPI</span><span class="p">(</span><span class="n">lifespan</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_lifespan</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_setup_routes</span><span class="p">()</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_config</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Config</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_app</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">port</span><span class="p">,</span> <span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span> <span class="o">=</span> <span class="n">uvicorn</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_config</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.get_completed_rollout" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_completed_rollout</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.get_completed_rollout" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Retrieves a specific completed rollout by its ID.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">get_completed_rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Rollout</span><span class="p">]:</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a><span class="sd">    Retrieves a specific completed rollout by its ID.</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">retrieve_rollout</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.poll_completed_rollout" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">poll_completed_rollout</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.poll_completed_rollout" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Polls for a completed rollout by its ID, waiting up to <code>timeout</code> seconds.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-334" name="__codelineno-0-334"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">poll_completed_rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Rollout</span><span class="p">]:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a><span class="sd">    Polls for a completed rollout by its ID, waiting up to `timeout` seconds.</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">rollout</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_completed_rollout</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="k">if</span> <span class="n">rollout</span><span class="p">:</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>            <span class="k">return</span> <span class="n">rollout</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="k">if</span> <span class="n">timeout</span> <span class="ow">and</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">:</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.queue_task" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">queue_task</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">resources_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.queue_task" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Adds a task to the queue for a client to process.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-301" name="__codelineno-0-301"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">queue_task</span><span class="p">(</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>    <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>    <span class="n">sample</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>    <span class="n">mode</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;train&quot;</span><span class="p">,</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span> <span class="s2">&quot;test&quot;</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="n">resources_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a><span class="sd">    Adds a task to the queue for a client to process.</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">,</span> <span class="n">resources_id</span><span class="o">=</span><span class="n">resources_id</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.retrieve_completed_rollouts" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">retrieve_completed_rollouts</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.retrieve_completed_rollouts" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Retrieves all available completed trajectories and clears the internal store.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-347" name="__codelineno-0-347"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retrieve_completed_rollouts</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Rollout</span><span class="p">]:</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a><span class="sd">    Retrieves all available completed trajectories and clears the internal store.</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">retrieve_completed_rollouts</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.run_forever" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run_forever</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.run_forever" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Runs the server indefinitely until stopped.
This is useful when async start and stop methods do not work.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">run_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">    Runs the server indefinitely until stopped.</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">    This is useful when async start and stop methods do not work.</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">serve</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.start" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">start</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.start" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Starts the FastAPI server in the background.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-280" name="__codelineno-0-280"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Starts the FastAPI server in the background.&quot;&quot;&quot;</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Starting server at </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">endpoint</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>    <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">serve</span><span class="p">())</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Allow time for server to start up.</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.stop" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">stop</span><span class="p">()</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.stop" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Gracefully stops the running FastAPI server.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-286" name="__codelineno-0-286"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Gracefully stops the running FastAPI server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Stopping server...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_uvicorn_server</span><span class="o">.</span><span class="n">should_exit</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Allow time for graceful shutdown.</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Server stopped.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentLightningServer.update_resources" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">update_resources</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span></code>

  <span class="doc doc-labels">
      <small class="doc doc-label doc-label-async"><code>async</code></small>
  </span>

<a href="#agentlightning.verl.AgentLightningServer.update_resources" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Updates the resources, creating a new version and setting it as the latest.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/server.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-315" name="__codelineno-0-315"></a><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">update_resources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="n">NamedResources</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a><span class="sd">    Updates the resources, creating a new version and setting it as the latest.</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="p">:</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Store not initialized. The server may not be running.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="n">resources_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;res-</span><span class="si">{</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>    <span class="n">update</span> <span class="o">=</span> <span class="n">ResourcesUpdate</span><span class="p">(</span><span class="n">resources_id</span><span class="o">=</span><span class="n">resources_id</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">)</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_store</span><span class="o">.</span><span class="n">update_resources</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="k">return</span> <span class="n">resources_id</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="agentlightning.verl.AgentLightningTrainer" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>AgentLightningTrainer</code>


<a href="#agentlightning.verl.AgentLightningTrainer" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="verl.trainer.ppo.ray_trainer.RayPPOTrainer">RayPPOTrainer</span></code></p>


        <p>Specialized PPO trainer for agent-based reinforcement learning.</p>
<p>This trainer is designed specifically for scenarios where the model interacts with
external environments, tools, or APIs through an AgentLightningServer. It simplifies
the training loop by removing the complex conditional logic present in the original
RayPPOTrainer and focusing on the agent mode workflow.</p>
<p>Key differences from RayPPOTrainer:
1. Uses AgentModeDaemon for server communication
2. Simplified data flow without pop/union operations
3. Direct batch processing through agent daemon
4. Streamlined validation using agent_mode validation</p>








              <details class="quote">
                <summary>Source code in <code>agentlightning/verl/trainer.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentLightningTrainer</span><span class="p">(</span><span class="n">RayPPOTrainer</span><span class="p">):</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">    Specialized PPO trainer for agent-based reinforcement learning.</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    This trainer is designed specifically for scenarios where the model interacts with</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    external environments, tools, or APIs through an AgentLightningServer. It simplifies</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    the training loop by removing the complex conditional logic present in the original</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">    RayPPOTrainer and focusing on the agent mode workflow.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Key differences from RayPPOTrainer:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    1. Uses AgentModeDaemon for server communication</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    2. Simplified data flow without pop/union operations</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    3. Direct batch processing through agent daemon</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    4. Streamlined validation using agent_mode validation</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;Please set val_batch_size to None for better throughput.&quot;</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">test_data</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">val_dataloader</span><span class="p">))</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">test_batch</span> <span class="o">=</span> <span class="n">DataProto</span><span class="o">.</span><span class="n">from_single_dict</span><span class="p">(</span><span class="n">test_data</span><span class="p">)</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">wake_up</span><span class="p">()</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">set_up_data_and_server</span><span class="p">(</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">test_batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">server_addresses</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">is_train</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="p">)</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">run_until_all_finished</span><span class="p">()</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">test_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">get_test_metrics</span><span class="p">()</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">clear_data_and_server</span><span class="p">()</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="k">return</span> <span class="n">test_metrics</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_train_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_dict</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="c1"># Isolate in a separate method to automatically recycle the variables before validation.</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="n">batch</span><span class="p">:</span> <span class="n">DataProto</span> <span class="o">=</span> <span class="n">DataProto</span><span class="o">.</span><span class="n">from_single_dict</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="n">timing_raw</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="c1"># When agent mode is enabled, we read the batch as it is.</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">gen_batch</span> <span class="o">=</span> <span class="n">batch</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="c1"># generate a batch</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;gen&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">wake_up</span><span class="p">()</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">set_up_data_and_server</span><span class="p">(</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                    <span class="n">gen_batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">server_addresses</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>                <span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">run_until_all_finished</span><span class="p">()</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>                <span class="n">batch</span><span class="p">,</span> <span class="n">agent_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">get_train_data_batch</span><span class="p">(</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                    <span class="n">max_prompt_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_prompt_length</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                    <span class="n">max_response_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max_response_length</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                    <span class="n">device</span><span class="o">=</span><span class="n">gen_batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;fake_ids&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">agent_metrics</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">clear_data_and_server</span><span class="p">()</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_manager</span><span class="o">.</span><span class="n">sleep</span><span class="p">()</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">adv_estimator</span> <span class="o">==</span> <span class="n">AdvantageEstimator</span><span class="o">.</span><span class="n">REMAX</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;gen_max&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                    <span class="n">gen_baseline_batch</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="n">gen_batch</span><span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                    <span class="n">gen_baseline_batch</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;do_sample&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                    <span class="n">gen_baseline_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_rollout_wg</span><span class="o">.</span><span class="n">generate_sequences</span><span class="p">(</span><span class="n">gen_baseline_batch</span><span class="p">)</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">gen_baseline_output</span><span class="p">)</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="n">reward_baseline_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_fn</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                    <span class="n">reward_baseline_tensor</span> <span class="o">=</span> <span class="n">reward_baseline_tensor</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">batch_keys</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">gen_baseline_output</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;reward_baselines&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reward_baseline_tensor</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                    <span class="k">del</span> <span class="n">gen_baseline_batch</span><span class="p">,</span> <span class="n">gen_baseline_output</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="c1"># uid is used for algorithm like GRPO, should be aligned to data id</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;data_id_list&quot;</span><span class="p">]</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;response_mask&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">compute_response_mask</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="c1"># compute global_valid tokens</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;global_token_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;attention_mask&quot;</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;reward&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="c1"># compute reward model score</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rm</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                    <span class="n">reward_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rm_wg</span><span class="o">.</span><span class="n">compute_rm_score</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">reward_tensor</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">reward_extra_infos_dict</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="c1"># for agent mode, pad the lengths to calculate old log prob, ref, and values</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">batch</span><span class="p">,</span> <span class="n">pad_size</span> <span class="o">=</span> <span class="n">pad_dataproto_to_divisor</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_rollout_wg</span><span class="o">.</span><span class="n">world_size</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="c1"># recompute old_log_probs</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;old_log_prob&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">old_log_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_rollout_wg</span><span class="o">.</span><span class="n">compute_log_prob</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="n">entropys</span> <span class="o">=</span> <span class="n">old_log_prob</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;entropys&quot;</span><span class="p">]</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="n">response_masks</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;response_mask&quot;</span><span class="p">]</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="n">loss_agg_mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">loss_agg_mode</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="n">entropy_loss</span> <span class="o">=</span> <span class="n">agg_loss</span><span class="p">(</span><span class="n">loss_mat</span><span class="o">=</span><span class="n">entropys</span><span class="p">,</span> <span class="n">loss_mask</span><span class="o">=</span><span class="n">response_masks</span><span class="p">,</span> <span class="n">loss_agg_mode</span><span class="o">=</span><span class="n">loss_agg_mode</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="n">old_log_prob_metrics</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;actor/entropy_loss&quot;</span><span class="p">:</span> <span class="n">entropy_loss</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">item</span><span class="p">()}</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_log_prob_metrics</span><span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="n">old_log_prob</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;entropys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">old_log_prob</span><span class="p">)</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_reference_policy</span><span class="p">:</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="c1"># compute reference log_prob</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;ref&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                    <span class="n">ref_log_prob</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_policy_wg</span><span class="o">.</span><span class="n">compute_ref_log_prob</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">ref_log_prob</span><span class="p">)</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="c1"># compute values</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_critic</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;values&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                    <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic_wg</span><span class="o">.</span><span class="n">compute_values</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                    <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="c1"># for agent mode, unpad to calculate adv</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="c1"># it is important, as adv should be based on the raw traces</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">unpad_dataproto</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">pad_size</span><span class="o">=</span><span class="n">pad_size</span><span class="p">)</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;adv&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="c1"># if agent_mode is enabled, there is already token_level_scores</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="c1"># token_level_scores is not needed to compute here</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="c1"># compute rewards. apply_kl_penalty if available</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">use_kl_in_reward</span><span class="p">:</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                    <span class="n">batch</span><span class="p">,</span> <span class="n">kl_metrics</span> <span class="o">=</span> <span class="n">apply_kl_penalty</span><span class="p">(</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                        <span class="n">batch</span><span class="p">,</span> <span class="n">kl_ctrl</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">kl_ctrl_in_reward</span><span class="p">,</span> <span class="n">kl_penalty</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">kl_penalty</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                    <span class="p">)</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kl_metrics</span><span class="p">)</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;token_level_rewards&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;token_level_scores&quot;</span><span class="p">]</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="c1"># compute advantages, executed on the driver process</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="n">norm_adv_by_std_in_grpo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="s2">&quot;norm_adv_by_std_in_grpo&quot;</span><span class="p">,</span> <span class="kc">True</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                <span class="p">)</span>  <span class="c1"># GRPO adv normalization factor</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="n">batch</span> <span class="o">=</span> <span class="n">compute_advantage</span><span class="p">(</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                    <span class="n">batch</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="n">adv_estimator</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">adv_estimator</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">gamma</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="n">lam</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="o">.</span><span class="n">lam</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                    <span class="n">num_repeat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                    <span class="n">norm_adv_by_std_in_grpo</span><span class="o">=</span><span class="n">norm_adv_by_std_in_grpo</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                    <span class="n">config</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">algorithm</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="c1"># after advantages are assinged, we begin to drop (1) long prompt (2) floor to ppo minisize</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">keep_indices</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;is_drop_mask&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">as_tuple</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;agent_mode/n_dropped_sample_because_of_prompt&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;is_drop_mask&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">keep_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="n">keep_indices</span><span class="p">]</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="c1"># next, round to minibatch size</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">mini_batch_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ppo_mini_batch_size</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">n_transition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">random_indices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_transition</span><span class="p">))</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">random_indices</span><span class="p">)</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="n">batch</span><span class="o">.</span><span class="n">reorder</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">random_indices</span><span class="p">)</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">int32</span><span class="p">))</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="n">n_remained_transition</span> <span class="o">=</span> <span class="n">n_transition</span> <span class="o">//</span> <span class="n">mini_batch_size</span> <span class="o">*</span> <span class="n">mini_batch_size</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">batch</span> <span class="o">=</span> <span class="n">batch</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n_remained_transition</span><span class="p">))]</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="n">metrics</span><span class="p">[</span><span class="s2">&quot;agent_mode/n_dropped_sample_because_of_mini_batch&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_transition</span> <span class="o">-</span> <span class="n">n_remained_transition</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="c1"># Agent mode note: Change the order of balance batch;</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="c1">#     1. first calculate advantage</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="c1">#     2. then drop the samples (too long prompt &amp; floor to ppo minisize)</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>            <span class="c1">#     3. balance</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="c1"># balance the number of valid tokens on each dp rank.</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="c1"># Note that this breaks the order of data inside the batch.</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="c1"># Please take care when you implement group based adv computation such as GRPO and rloo</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">balance_batch</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_balance_batch</span><span class="p">(</span><span class="n">batch</span><span class="p">,</span> <span class="n">metrics</span><span class="o">=</span><span class="n">metrics</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="c1"># update critic</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_critic</span><span class="p">:</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;update_critic&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                    <span class="n">critic_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">critic_wg</span><span class="o">.</span><span class="n">update_critic</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="n">critic_output_metrics</span> <span class="o">=</span> <span class="n">reduce_metrics</span><span class="p">(</span><span class="n">critic_output</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">])</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">critic_output_metrics</span><span class="p">)</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="c1"># implement critic warmup</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">critic_warmup</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">:</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="c1"># update actor</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;update_actor&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                    <span class="n">batch</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;multi_turn&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">multi_turn</span><span class="o">.</span><span class="n">enable</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                    <span class="n">actor_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">actor_rollout_wg</span><span class="o">.</span><span class="n">update_actor</span><span class="p">(</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="n">actor_output_metrics</span> <span class="o">=</span> <span class="n">reduce_metrics</span><span class="p">(</span><span class="n">actor_output</span><span class="o">.</span><span class="n">meta_info</span><span class="p">[</span><span class="s2">&quot;metrics&quot;</span><span class="p">])</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">actor_output_metrics</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="c1"># Log rollout generations if enabled</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">rollout_data_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;rollout_data_dir&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="k">if</span> <span class="n">rollout_data_dir</span><span class="p">:</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>                <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;dump_rollout_generations&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>                    <span class="nb">print</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>                    <span class="n">inputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;prompts&quot;</span><span class="p">],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>                    <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">batch_decode</span><span class="p">(</span><span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;responses&quot;</span><span class="p">],</span> <span class="n">skip_special_tokens</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>                    <span class="n">scores</span> <span class="o">=</span> <span class="n">batch</span><span class="o">.</span><span class="n">batch</span><span class="p">[</span><span class="s2">&quot;token_level_scores&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_dump_generations</span><span class="p">(</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>                        <span class="n">inputs</span><span class="o">=</span><span class="n">inputs</span><span class="p">,</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>                        <span class="n">outputs</span><span class="o">=</span><span class="n">outputs</span><span class="p">,</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                        <span class="n">scores</span><span class="o">=</span><span class="n">scores</span><span class="p">,</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                        <span class="n">reward_extra_infos_dict</span><span class="o">=</span><span class="n">reward_extra_infos_dict</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                        <span class="n">dump_path</span><span class="o">=</span><span class="n">rollout_data_dir</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                    <span class="p">)</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="c1"># compute training metrics</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compute_data_metrics</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">use_critic</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_critic</span><span class="p">))</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compute_timing_metrics</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">timing_raw</span><span class="o">=</span><span class="n">timing_raw</span><span class="p">))</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="c1"># TODO: implement actual tflpo and theoretical tflpo</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">n_gpus</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resource_pool_manager</span><span class="o">.</span><span class="n">get_n_gpus</span><span class="p">()</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">compute_throughout_metrics</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">,</span> <span class="n">timing_raw</span><span class="o">=</span><span class="n">timing_raw</span><span class="p">,</span> <span class="n">n_gpus</span><span class="o">=</span><span class="n">n_gpus</span><span class="p">))</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="k">return</span> <span class="n">metrics</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">logger</span> <span class="o">=</span> <span class="n">Tracking</span><span class="p">(</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">project_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="n">experiment_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">experiment_name</span><span class="p">,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="n">default_backend</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="n">config</span><span class="o">=</span><span class="n">OmegaConf</span><span class="o">.</span><span class="n">to_container</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> <span class="n">resolve</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="p">)</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>        <span class="c1"># load checkpoint before doing anything</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_load_checkpoint</span><span class="p">()</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_rollout_mode</span><span class="p">,</span> <span class="s2">&quot;If agent mode is enabled, async server must be enabled&quot;</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span> <span class="o">=</span> <span class="n">AgentModeDaemon</span><span class="p">(</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">agentlightning</span><span class="o">.</span><span class="n">port</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">n</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="n">train_information</span><span class="o">=</span><span class="p">{</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>                <span class="c1"># Note (Zhiyuan): To avoid further patch into vllm async server, using the same sentence to get the naming here.</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>                <span class="c1"># However, it is possible that verl updates the naming and causes incompatibility.</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>                <span class="c1"># Reference: https://github.com/volcengine/verl/blob/5b5e09d9cc20625e436d01f69d9cc739ff681c54/verl/workers/rollout/vllm_rollout/vllm_async_server.py#L217</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>                <span class="s2">&quot;model&quot;</span><span class="p">:</span> <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]),</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>                <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">rollout</span><span class="o">.</span><span class="n">temperature</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="p">},</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="n">tokenizer</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="n">mini_batch_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">actor_rollout_ref</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">ppo_mini_batch_size</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">pad_token_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">pad_token_id</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="p">)</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">agent_mode_daemon</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="c1"># perform validation before training</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="c1"># currently, we only support validation using the reward_function.</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">val_reward_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;val_before_train&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="n">val_metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="k">assert</span> <span class="n">val_metrics</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">val_metrics</span><span class="si">=}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initial validation metrics: </span><span class="si">{</span><span class="n">val_metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">val_metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;val_only&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="k">return</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="c1"># add tqdm</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="n">progress_bar</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">total_training_steps</span><span class="p">,</span> <span class="n">initial</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">,</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Training Progress&quot;</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="c1"># we start from step 1</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="n">last_val_metrics</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">total_epochs</span><span class="p">):</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>            <span class="k">for</span> <span class="n">batch_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataloader</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>                <span class="n">metrics</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>                <span class="n">timing_raw</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                <span class="n">is_last_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_training_steps</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>                <span class="c1"># train step</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="n">metrics</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_train_step</span><span class="p">(</span><span class="n">batch_dict</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>                <span class="c1"># validate</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>                <span class="k">if</span> <span class="p">(</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">val_reward_fn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>                    <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">test_freq</span> <span class="o">&gt;</span> <span class="mi">0</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>                    <span class="ow">and</span> <span class="p">(</span><span class="n">is_last_step</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">test_freq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>                <span class="p">):</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>                    <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;validate&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>                        <span class="n">val_metrics</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>                        <span class="k">if</span> <span class="n">is_last_step</span><span class="p">:</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>                            <span class="n">last_val_metrics</span> <span class="o">=</span> <span class="n">val_metrics</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>                    <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">val_metrics</span><span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>                    <span class="n">is_last_step</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trainer</span><span class="o">.</span><span class="n">save_freq</span> <span class="o">==</span> <span class="mi">0</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>                <span class="p">):</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>                    <span class="k">with</span> <span class="n">_timer</span><span class="p">(</span><span class="s2">&quot;save_checkpoint&quot;</span><span class="p">,</span> <span class="n">timing_raw</span><span class="p">):</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>                        <span class="bp">self</span><span class="o">.</span><span class="n">_save_checkpoint</span><span class="p">()</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>                <span class="c1"># step metrics</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>                <span class="n">metrics</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>                    <span class="p">{</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                        <span class="s2">&quot;training/global_step&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">,</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                        <span class="s2">&quot;training/epoch&quot;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                    <span class="p">}</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>                <span class="c1"># TODO: make a canonical logger that supports various backend</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="n">logger</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">metrics</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="p">)</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                <span class="k">if</span> <span class="n">is_last_step</span><span class="p">:</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Final validation metrics: </span><span class="si">{</span><span class="n">last_val_metrics</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                    <span class="n">progress_bar</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                    <span class="c1"># This exit logic is to ensure a robust CI.</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flush the logger...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                    <span class="k">del</span> <span class="n">logger</span>  <span class="c1"># Make sure the loggers are flushed and closed properly</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                    <span class="n">pprint</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Training finished at step </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>                    <span class="k">return</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>                <span class="n">progress_bar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">global_steps</span> <span class="o">+=</span> <span class="mi">1</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="agentlightning.verl.AgentModeDaemon" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>AgentModeDaemon</code>


<a href="#agentlightning.verl.AgentModeDaemon" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">


        <p>AgentModeDaemon using the AgentLightningServer SDK.</p>
<p>This class manages the server lifecycle, task queueing, and results
retrieval, while also running a proxy server for LLM requests. It maintains
the original interface for compatibility with the RayPPOTrainer.</p>








              <details class="quote">
                <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="k">class</span><span class="w"> </span><span class="nc">AgentModeDaemon</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    AgentModeDaemon using the AgentLightningServer SDK.</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    This class manages the server lifecycle, task queueing, and results</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    retrieval, while also running a proxy server for LLM requests. It maintains</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    the original interface for compatibility with the RayPPOTrainer.</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">port</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">train_rollout_n</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">train_information</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">tokenizer</span><span class="p">,</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">mini_batch_size</span><span class="p">,</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">pad_token_id</span><span class="p">,</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">reward_fillna_value</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">llm_timeout_seconds</span><span class="o">=</span><span class="mf">600.0</span><span class="p">,</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="p">):</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="c1"># Server and Task Configuration</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server_port</span> <span class="o">=</span> <span class="n">port</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span> <span class="o">=</span> <span class="n">llm_timeout_seconds</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">server</span> <span class="o">=</span> <span class="n">AgentLightningServer</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="p">,</span> <span class="n">task_timeout_seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span> <span class="o">=</span> <span class="n">_find_available_port</span><span class="p">()</span>  <span class="c1"># Run proxy on a different port</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="c1"># Training and Data Configuration</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_rollout_n</span> <span class="o">=</span> <span class="n">train_rollout_n</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">train_information</span> <span class="o">=</span> <span class="n">train_information</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_size</span> <span class="o">=</span> <span class="n">mini_batch_size</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span> <span class="o">=</span> <span class="n">pad_token_id</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tokenizer</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span> <span class="o">=</span> <span class="n">reward_fillna_value</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="c1"># Internal State</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Rollout</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_thread</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_start_proxy_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a><span class="sd">        Initializes and runs a Flask-based proxy server in a separate thread.</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a><span class="sd">        This proxy load-balances requests to the actual backend LLM servers.</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="n">num_requests</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">last_request_time</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/v1/&lt;path:path&gt;&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;POST&quot;</span><span class="p">,</span> <span class="s2">&quot;PUT&quot;</span><span class="p">,</span> <span class="s2">&quot;DELETE&quot;</span><span class="p">,</span> <span class="s2">&quot;PATCH&quot;</span><span class="p">,</span> <span class="s2">&quot;OPTIONS&quot;</span><span class="p">,</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">])</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">proxy</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span><span class="p">:</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="n">abort</span><span class="p">(</span><span class="mi">503</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;No backend LLM servers available.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="c1"># Randomly choose a backend server for load balancing</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">target_server</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="n">target_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;http://</span><span class="si">{</span><span class="n">target_server</span><span class="si">}</span><span class="s2">/v1/</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="c1"># Copy client request headers, removing the Host header</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span> <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;host&quot;</span><span class="p">}</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="c1"># Log the request for debugging</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="k">nonlocal</span> <span class="n">num_requests</span><span class="p">,</span> <span class="n">last_request_time</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">current_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">num_requests</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">if</span> <span class="n">current_time</span> <span class="o">-</span> <span class="n">last_request_time</span> <span class="o">&gt;</span> <span class="mi">60</span> <span class="ow">or</span> <span class="n">num_requests</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">num_requests</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxying </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> request to </span><span class="si">{</span><span class="n">target_server</span><span class="si">}</span><span class="s2">. Request data: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>            <span class="n">last_request_time</span> <span class="o">=</span> <span class="n">current_time</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>            <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="c1"># Forward the request to the target backend</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>                <span class="n">resp</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                    <span class="n">method</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="p">,</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="n">url</span><span class="o">=</span><span class="n">target_url</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                    <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                    <span class="n">params</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                    <span class="n">data</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">get_data</span><span class="p">(),</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                    <span class="n">cookies</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">cookies</span><span class="p">,</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                    <span class="n">allow_redirects</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">llm_timeout_seconds</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="p">)</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="c1"># Filter out hop-by-hop headers before returning the response</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>                <span class="n">excluded_headers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>                    <span class="s2">&quot;content-encoding&quot;</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>                    <span class="s2">&quot;content-length&quot;</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>                    <span class="s2">&quot;transfer-encoding&quot;</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                    <span class="s2">&quot;connection&quot;</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                    <span class="s2">&quot;keep-alive&quot;</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                    <span class="s2">&quot;proxy-authenticate&quot;</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="s2">&quot;proxy-authorization&quot;</span><span class="p">,</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="s2">&quot;te&quot;</span><span class="p">,</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                    <span class="s2">&quot;trailers&quot;</span><span class="p">,</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                    <span class="s2">&quot;upgrade&quot;</span><span class="p">,</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                <span class="p">]</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resp</span><span class="o">.</span><span class="n">raw</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_headers</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                <span class="p">]</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="k">if</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">:</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>                    <span class="c1"># NOTE: from Zhiyuan&#39;s code.</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>                    <span class="c1"># https://github.com/hzy46/verl_agent_mode/blob/2db65ea9858f645a914120357412a7540f8bd82d/verl/trainer/ppo/ray_trainer.py#L692-L711</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>                    <span class="c1"># request_json = json.loads(request.get_data().decode(&quot;utf-8&quot;))</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                    <span class="n">response_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">))</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                    <span class="c1"># response_message = ChatCompletion(**response_json).choices[0].message.model_dump(exclude_unset=True, exclude_none=True)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                    <span class="c1"># tool_schemas = request_json.get(&quot;tools&quot;, None)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                    <span class="c1"># prompt_ids = self.tokenizer.apply_chat_template(request_json[&quot;messages&quot;], tools=tool_schemas, add_generation_prompt=True, tokenize=True)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                    <span class="c1"># full_ids = self.tokenizer.apply_chat_template(request_json[&quot;messages&quot;] + [response_message], tools=tool_schemas, add_generation_prompt=False, tokenize=True)</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                    <span class="c1"># TBD: response_ids sometimes ends with &quot;&lt;eos_id&gt;\n&quot;, shall we keep the extra &quot;\n&quot;?</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>                    <span class="c1"># sometimes it has some differences with the hacky method in the end, but this should align with ToolCompletionCallback</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                    <span class="c1"># response_ids = full_ids[len(prompt_ids):]</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                    <span class="c1"># NOTE (yuge): They are different. Don&#39;t know why.</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                    <span class="c1"># assert response_json[&#39;prompt_token_ids&#39;] == prompt_ids</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                    <span class="c1"># patched_response_ids = response_json[&#39;response_token_ids&#39;][0]</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>                    <span class="c1"># assert patched_response_ids == response_ids[:len(patched_response_ids)], f&quot;{patched_response_ids} != {response_ids[:len(patched_response_ids)]}&quot;</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                    <span class="c1"># response_json[&#39;prompt_token_ids&#39;] = prompt_ids</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="c1"># response_json[&#39;response_token_ids&#39;] = [response_ids]</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                    <span class="n">replaced_return_content</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response_json</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">replaced_return_content</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">response_headers</span><span class="p">)</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">resp</span><span class="o">.</span><span class="n">content</span><span class="p">,</span> <span class="n">resp</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>                <span class="n">abort</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Error proxying request: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">run_app</span><span class="p">():</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="s2">&quot;0.0.0.0&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_app</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_proxy_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Proxy server running on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Starts the main AgentLightningServer and the proxy server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="k">def</span><span class="w"> </span><span class="nf">run_server</span><span class="p">():</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="w">            </span><span class="sd">&quot;&quot;&quot;Run the AgentLightningServer in a separate thread.&quot;&quot;&quot;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">run_forever</span><span class="p">())</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_server</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="c1"># Wait for the server&#39;s internal startup event to be set.</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for AgentLightningServer to start...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>  <span class="c1"># Wait up to 20s</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ready</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AgentLightningServer failed to start within the timeout period.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AgentLightningServer control plane running on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_start_proxy_server</span><span class="p">()</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_set_up</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async helper to set up data and resources on the server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">clear_data_and_server</span><span class="p">()</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span> <span class="o">=</span> <span class="n">server_addresses</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span> <span class="o">=</span> <span class="n">is_train</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="c1"># 1. Update resources on the server for clients to use</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="n">llm_resource</span> <span class="o">=</span> <span class="n">LLM</span><span class="p">(</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">endpoint</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;http://127.0.0.1:</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">proxy_port</span><span class="si">}</span><span class="s2">/v1&quot;</span><span class="p">,</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>            <span class="n">model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">train_information</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;default-model&quot;</span><span class="p">),</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="n">sampling_parameters</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_information</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;temperature&quot;</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)},</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>        <span class="p">)</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="n">resources</span><span class="p">:</span> <span class="n">NamedResources</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;main_llm&quot;</span><span class="p">:</span> <span class="n">llm_resource</span><span class="p">}</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">resources_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">update_resources</span><span class="p">(</span><span class="n">resources</span><span class="p">)</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>        <span class="c1"># 2. Queue tasks for agents to process</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="n">num_samples</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">rollouts_per_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_rollout_n</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="mi">1</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>            <span class="n">data_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="n">original_sample</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">}</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>            <span class="n">original_sample</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data_id</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>            <span class="c1"># For training, each sample is rolled out multiple times</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rollouts_per_sample</span><span class="p">):</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                <span class="n">task_metadata</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;data_id&quot;</span><span class="p">:</span> <span class="n">data_id</span><span class="p">,</span> <span class="s2">&quot;is_train&quot;</span><span class="p">:</span> <span class="n">is_train</span><span class="p">}</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                <span class="c1"># Data ID is different from Rollout ID, as one data can have multiple rollouts.</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                <span class="n">rollout_id</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">queue_task</span><span class="p">(</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                    <span class="n">sample</span><span class="o">=</span><span class="n">original_sample</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;train&quot;</span> <span class="k">if</span> <span class="n">is_train</span> <span class="k">else</span> <span class="s2">&quot;val&quot;</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>                    <span class="n">resources_id</span><span class="o">=</span><span class="n">resources_id</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                    <span class="n">metadata</span><span class="o">=</span><span class="n">task_metadata</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>                <span class="c1"># Store original sample data to reconstruct batch information later</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_sample</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">set_up_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronous wrapper for setting up data and server resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_set_up</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Wait for completion with a timeout</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to set up data on server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="k">raise</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout</span><span class="p">:</span> <span class="n">Rollout</span><span class="p">):</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">final_reward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="nb">print</span><span class="p">(</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>                <span class="sa">f</span><span class="s2">&quot;Warning: Reward is None for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">, will be auto-set to </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="p">)</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Triplet is None for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Length of triplets is 0 for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">):</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2"> contains empty response: </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="k">elif</span> <span class="nb">any</span><span class="p">(</span><span class="ow">not</span> <span class="n">r</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">):</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Warning: Rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2"> contains empty prompt: </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_async_run_until_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Async helper to wait for all tasks to complete.&quot;&quot;&quot;</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="n">completed_batch</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">retrieve_completed_rollouts</span><span class="p">()</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="k">for</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="n">completed_batch</span><span class="p">:</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_data</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">[</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">rollout</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Completed </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span><span class="si">}</span><span class="s2"> tasks...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;All tasks finished.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_until_all_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Synchronously waits for all queued tasks to be completed and reported.&quot;&quot;&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No tasks were queued.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="k">return</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_run_until_finished</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Wait indefinitely for all tasks to complete</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while waiting for tasks to finish: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="k">raise</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_test_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculates and returns metrics for a validation run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during validation.&quot;</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>        <span class="n">sample_stat_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="k">continue</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="n">response_length_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">triplet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">triplet</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">]</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>            <span class="n">sample_stat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="p">{</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                    <span class="s2">&quot;sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">),</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                    <span class="s2">&quot;mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_length_list</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                    <span class="s2">&quot;turn_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">),</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                    <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>                <span class="p">}</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>        <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="s2">&quot;val/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>            <span class="s2">&quot;val/mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;mean_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>            <span class="s2">&quot;val/sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;sum_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="s2">&quot;val/turn_count&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;turn_count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="p">}</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">get_train_data_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">        Processes completed rollouts to generate a training data batch.</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">        This function reconstructs the logic from the original AgentModeDaemon,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">        using data retrieved from the new server architecture. It handles padding,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        truncation, and tensor creation for the PPO training loop.</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during training.&quot;</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>        <span class="c1"># 1. Reconstruct the `finished_id_to_sample_info` structure from completed rollouts</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">finished_id_to_sample_info</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="n">original_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>                <span class="k">continue</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="c1"># The client should report triplets that contain prompt_ids and response_ids.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="c1"># Example triplet.prompt: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="c1"># Example triplet.response: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="n">trace_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                <span class="p">{</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="s2">&quot;response_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])}</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="p">]</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>                <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="s2">&quot;trace_list&quot;</span><span class="p">:</span> <span class="n">trace_list</span><span class="p">,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                <span class="s2">&quot;data_id&quot;</span><span class="p">:</span> <span class="n">original_sample</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="p">}</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="n">finished_id_to_sample_info</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>        <span class="c1">#</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="c1"># --- Data processing and tensor creation logic ---</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="c1"># Get all the reported data.</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="c1"># prompt_ids are left-padded.</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="c1"># response_ids are right-padded.</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="c1"># They are concatenated in the middle.</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="c1"># Discard handling:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="c1">#   - Those exceeding max_prompt_length will be marked for discard, but not</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="c1">#     discarded here. They are only truncated and marked, to be discarded later.</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="c1">#     This is for the correctness of the advantage calculation.</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="c1">#   - The discard for the PPO mini-batch should also be handled this way.</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">input_ids_list</span><span class="p">,</span> <span class="n">input_attention_mask_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="n">response_ids_list</span><span class="p">,</span> <span class="n">response_attention_mask_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="n">reward_list</span><span class="p">,</span> <span class="n">data_id_list</span><span class="p">,</span> <span class="n">rollout_id_list</span><span class="p">,</span> <span class="n">turn_index_list</span><span class="p">,</span> <span class="n">is_drop_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="n">n_trunc_sample_because_of_response</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">sample_info</span> <span class="ow">in</span> <span class="n">finished_id_to_sample_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>            <span class="k">for</span> <span class="n">turn_index</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;trace_list&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="n">reward_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">])</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">response_ids</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;response_ids&quot;</span><span class="p">]</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="c1"># Mark samples with prompts exceeding max_prompt_length to be dropped later</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_prompt_length</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                    <span class="n">prompt_ids</span> <span class="o">=</span> <span class="n">prompt_ids</span><span class="p">[:</span><span class="n">max_prompt_length</span><span class="p">]</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                    <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                    <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="c1"># Truncate responses that exceed max_response_length</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_response_length</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                    <span class="n">response_ids</span> <span class="o">=</span> <span class="n">response_ids</span><span class="p">[:</span><span class="n">max_response_length</span><span class="p">]</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                    <span class="n">n_trunc_sample_because_of_response</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="c1"># Pad prompts to the left and responses to the right</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                <span class="n">one_input_ids</span><span class="p">,</span> <span class="n">one_input_attention_mask</span> <span class="o">=</span> <span class="n">get_left_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                    <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="n">one_response_ids</span><span class="p">,</span> <span class="n">one_response_attention_mask</span> <span class="o">=</span> <span class="n">get_right_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                    <span class="n">response_ids</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                <span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                <span class="n">input_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_ids</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                <span class="n">input_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                <span class="n">response_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_ids</span><span class="p">)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                <span class="n">response_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                <span class="n">data_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>                <span class="n">rollout_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                <span class="n">turn_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turn_index</span><span class="p">)</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="n">n_transition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="n">batch_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="n">input_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">batch_response_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>        <span class="n">response_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>        <span class="c1"># Concatenate prompts and responses to form the full sequence</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="n">batch_seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_input_ids</span><span class="p">,</span> <span class="n">batch_response_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_attention_mask</span><span class="p">,</span> <span class="n">response_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="n">position_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="n">is_drop_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">(</span><span class="n">is_drop_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reward_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="c1"># Create token-level scores by placing the final reward at the last token position</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>        <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="c1"># At the eos_mask_idx position of each sample, fill in the corresponding scores.</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>        <span class="c1"># torch.arange(n_transition) generates [0,1,2,...,bsz-1] as indices for the batch dimension.</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>        <span class="n">eos_mask_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">position_ids</span> <span class="o">*</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (bsz,)</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>        <span class="n">token_level_scores</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_transition</span><span class="p">),</span> <span class="n">eos_mask_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="c1"># Only take the last response_length part of the sequence to get the token-level scores for the model&#39;s response part.</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>        <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">token_level_scores</span><span class="p">[:,</span> <span class="o">-</span><span class="n">max_response_length</span><span class="p">:]</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="c1"># Form the final batch using TensorDict</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>        <span class="n">batch</span> <span class="o">=</span> <span class="n">TensorDict</span><span class="p">(</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>            <span class="p">{</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>                <span class="s2">&quot;prompts&quot;</span><span class="p">:</span> <span class="n">batch_input_ids</span><span class="p">,</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>                <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">batch_response_ids</span><span class="p">,</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>                <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">batch_seq</span><span class="p">,</span>  <span class="c1"># here input_ids become the whole sentences</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>                <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span><span class="p">,</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                <span class="s2">&quot;position_ids&quot;</span><span class="p">:</span> <span class="n">position_ids</span><span class="p">,</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="s2">&quot;is_drop_mask&quot;</span><span class="p">:</span> <span class="n">is_drop_mask</span><span class="p">,</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>                <span class="s2">&quot;token_level_scores&quot;</span><span class="p">:</span> <span class="n">token_level_scores</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>            <span class="p">},</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="n">batch_size</span><span class="o">=</span><span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>        <span class="p">)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>        <span class="n">data_proto</span> <span class="o">=</span> <span class="n">DataProto</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>        <span class="n">data_metrics</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>            <span class="s2">&quot;agent_mode/n_trunc_sample_because_of_response&quot;</span><span class="p">:</span> <span class="n">n_trunc_sample_because_of_response</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="s2">&quot;agent_mode/n_sample_to_train&quot;</span><span class="p">:</span> <span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>        <span class="p">}</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>        <span class="c1"># Add non-tensor data for advantage calculation and logging</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;data_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_id_list</span><span class="p">)</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>        <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;rollout_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rollout_id_list</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>        <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;turn_index_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">turn_index_list</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>        <span class="k">return</span> <span class="n">data_proto</span><span class="p">,</span> <span class="n">data_metrics</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">clear_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Resets the internal state of the daemon for the next run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="c1"># For a true reset, the server&#39;s internal queues would also need clearing.</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="c1"># This implementation assumes that `set_up_data_and_server` is called</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="c1"># for each new run, effectively starting a fresh batch.</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_fillna_reward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rollout</span><span class="p">):</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="k">if</span> <span class="n">rollout</span><span class="o">.</span><span class="n">final_reward</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>                <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reward_fillna_value</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reward is None for rollout </span><span class="si">{</span><span class="n">rollout</span><span class="o">.</span><span class="n">rollout_id</span><span class="si">}</span><span class="s2">, please check the reward function.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="n">final_reward</span> <span class="o">=</span> <span class="n">rollout</span><span class="o">.</span><span class="n">final_reward</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="k">return</span> <span class="n">final_reward</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">clear_data_and_server</span><span class="p">()</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.clear_data_and_server" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Resets the internal state of the daemon for the next run.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-498" name="__codelineno-0-498"></a><span class="k">def</span><span class="w"> </span><span class="nf">clear_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Resets the internal state of the daemon for the next run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">backend_llm_server_addresses</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">=</span> <span class="mi">0</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.get_test_metrics" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_test_metrics</span><span class="p">()</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.get_test_metrics" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Calculates and returns metrics for a validation run.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_test_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculates and returns metrics for a validation run.&quot;&quot;&quot;</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>    <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during validation.&quot;</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>    <span class="n">sample_stat_list</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>    <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="k">continue</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">response_length_list</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">triplet</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]))</span> <span class="k">for</span> <span class="n">triplet</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">]</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>        <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">sample_stat_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="p">{</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="s2">&quot;sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">),</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                <span class="s2">&quot;mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">response_length_list</span><span class="p">)</span> <span class="k">if</span> <span class="n">response_length_list</span> <span class="k">else</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                <span class="s2">&quot;turn_count&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">),</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="p">}</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>        <span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>    <span class="k">return</span> <span class="p">{</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>        <span class="s2">&quot;val/reward&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="s2">&quot;val/mean_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;mean_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="s2">&quot;val/sum_response_length&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;sum_response_length&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="s2">&quot;val/turn_count&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">([</span><span class="n">stat</span><span class="p">[</span><span class="s2">&quot;turn_count&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">stat</span> <span class="ow">in</span> <span class="n">sample_stat_list</span><span class="p">]),</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>    <span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">get_train_data_batch</span><span class="p">(</span><span class="n">max_prompt_length</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="n">device</span><span class="p">)</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.get_train_data_batch" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Processes completed rollouts to generate a training data batch.</p>
<p>This function reconstructs the logic from the original AgentModeDaemon,
using data retrieved from the new server architecture. It handles padding,
truncation, and tensor creation for the PPO training loop.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-365" name="__codelineno-0-365"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_train_data_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="n">device</span><span class="p">):</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="sd">    Processes completed rollouts to generate a training data batch.</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="sd">    This function reconstructs the logic from the original AgentModeDaemon,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">    using data retrieved from the new server architecture. It handles padding,</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">    truncation, and tensor creation for the PPO training loop.</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_train</span><span class="p">,</span> <span class="s2">&quot;This method should only be called during training.&quot;</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>    <span class="c1"># 1. Reconstruct the `finished_id_to_sample_info` structure from completed rollouts</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>    <span class="n">finished_id_to_sample_info</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>    <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_completed_rollouts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="n">original_sample</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_id_to_original_sample</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span><span class="p">:</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>            <span class="k">continue</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="c1"># The client should report triplets that contain prompt_ids and response_ids.</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="c1"># Example triplet.prompt: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>        <span class="c1"># Example triplet.response: {&quot;token_ids&quot;: [...]}</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">trace_list</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="p">{</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">prompt</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[]),</span> <span class="s2">&quot;response_ids&quot;</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token_ids&quot;</span><span class="p">,</span> <span class="p">[])}</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">rollout</span><span class="o">.</span><span class="n">triplets</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="p">]</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>        <span class="n">final_reward</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fillna_reward</span><span class="p">(</span><span class="n">rollout</span><span class="p">)</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="s2">&quot;reward&quot;</span><span class="p">:</span> <span class="n">final_reward</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>            <span class="s2">&quot;trace_list&quot;</span><span class="p">:</span> <span class="n">trace_list</span><span class="p">,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="s2">&quot;data_id&quot;</span><span class="p">:</span> <span class="n">original_sample</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">],</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>        <span class="p">}</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="n">finished_id_to_sample_info</span><span class="p">[</span><span class="n">rollout_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">info</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>    <span class="c1">#</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="c1"># --- Data processing and tensor creation logic ---</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>    <span class="c1"># Get all the reported data.</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>    <span class="c1"># prompt_ids are left-padded.</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>    <span class="c1"># response_ids are right-padded.</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>    <span class="c1"># They are concatenated in the middle.</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="c1"># Discard handling:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>    <span class="c1">#   - Those exceeding max_prompt_length will be marked for discard, but not</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="c1">#     discarded here. They are only truncated and marked, to be discarded later.</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>    <span class="c1">#     This is for the correctness of the advantage calculation.</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>    <span class="c1">#   - The discard for the PPO mini-batch should also be handled this way.</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>    <span class="n">input_ids_list</span><span class="p">,</span> <span class="n">input_attention_mask_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="n">response_ids_list</span><span class="p">,</span> <span class="n">response_attention_mask_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>    <span class="n">reward_list</span><span class="p">,</span> <span class="n">data_id_list</span><span class="p">,</span> <span class="n">rollout_id_list</span><span class="p">,</span> <span class="n">turn_index_list</span><span class="p">,</span> <span class="n">is_drop_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>    <span class="n">n_trunc_sample_because_of_response</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>    <span class="k">for</span> <span class="n">rollout_id</span><span class="p">,</span> <span class="n">sample_info</span> <span class="ow">in</span> <span class="n">finished_id_to_sample_info</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>        <span class="k">for</span> <span class="n">turn_index</span><span class="p">,</span> <span class="n">trace</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;trace_list&quot;</span><span class="p">]):</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">reward_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;reward&quot;</span><span class="p">])</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">response_ids</span> <span class="o">=</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;prompt_ids&quot;</span><span class="p">],</span> <span class="n">trace</span><span class="p">[</span><span class="s2">&quot;response_ids&quot;</span><span class="p">]</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="c1"># Mark samples with prompts exceeding max_prompt_length to be dropped later</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prompt_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_prompt_length</span><span class="p">:</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="n">prompt_ids</span> <span class="o">=</span> <span class="n">prompt_ids</span><span class="p">[:</span><span class="n">max_prompt_length</span><span class="p">]</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                <span class="n">is_drop_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="c1"># Truncate responses that exceed max_response_length</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_ids</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_response_length</span><span class="p">:</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="n">response_ids</span> <span class="o">=</span> <span class="n">response_ids</span><span class="p">[:</span><span class="n">max_response_length</span><span class="p">]</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                <span class="n">n_trunc_sample_because_of_response</span> <span class="o">+=</span> <span class="mi">1</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="c1"># Pad prompts to the left and responses to the right</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="n">one_input_ids</span><span class="p">,</span> <span class="n">one_input_attention_mask</span> <span class="o">=</span> <span class="n">get_left_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                <span class="n">prompt_ids</span><span class="p">,</span> <span class="n">max_prompt_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="p">)</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="n">one_response_ids</span><span class="p">,</span> <span class="n">one_response_attention_mask</span> <span class="o">=</span> <span class="n">get_right_padded_ids_and_attention_mask</span><span class="p">(</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                <span class="n">response_ids</span><span class="p">,</span> <span class="n">max_response_length</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pad_token_id</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="p">)</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>            <span class="n">input_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_ids</span><span class="p">)</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>            <span class="n">input_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_input_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>            <span class="n">response_ids_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_ids</span><span class="p">)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>            <span class="n">response_attention_mask_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">one_response_attention_mask</span><span class="p">)</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>            <span class="n">data_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sample_info</span><span class="p">[</span><span class="s2">&quot;data_id&quot;</span><span class="p">])</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>            <span class="n">rollout_id_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rollout_id</span><span class="p">)</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>            <span class="n">turn_index_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">turn_index</span><span class="p">)</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>    <span class="n">n_transition</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>    <span class="n">batch_input_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>    <span class="n">input_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">input_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>    <span class="n">batch_response_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_ids_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="n">response_attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">response_attention_mask_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>    <span class="c1"># Concatenate prompts and responses to form the full sequence</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>    <span class="n">batch_seq</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">batch_input_ids</span><span class="p">,</span> <span class="n">batch_response_ids</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>    <span class="n">attention_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">input_attention_mask</span><span class="p">,</span> <span class="n">response_attention_mask</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>    <span class="n">position_ids</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>    <span class="n">is_drop_mask</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">BoolTensor</span><span class="p">(</span><span class="n">is_drop_list</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>    <span class="n">scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">tensor</span><span class="p">(</span><span class="n">reward_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">bfloat16</span><span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>    <span class="c1"># Create token-level scores by placing the final reward at the last token position</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>    <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">attention_mask</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">scores</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>    <span class="c1"># At the eos_mask_idx position of each sample, fill in the corresponding scores.</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>    <span class="c1"># torch.arange(n_transition) generates [0,1,2,...,bsz-1] as indices for the batch dimension.</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>    <span class="n">eos_mask_idx</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">position_ids</span> <span class="o">*</span> <span class="n">attention_mask</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># (bsz,)</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>    <span class="n">token_level_scores</span><span class="p">[</span><span class="n">torch</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n_transition</span><span class="p">),</span> <span class="n">eos_mask_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">scores</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>    <span class="c1"># Only take the last response_length part of the sequence to get the token-level scores for the model&#39;s response part.</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>    <span class="n">token_level_scores</span> <span class="o">=</span> <span class="n">token_level_scores</span><span class="p">[:,</span> <span class="o">-</span><span class="n">max_response_length</span><span class="p">:]</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>    <span class="c1"># Form the final batch using TensorDict</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>    <span class="n">batch</span> <span class="o">=</span> <span class="n">TensorDict</span><span class="p">(</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="p">{</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>            <span class="s2">&quot;prompts&quot;</span><span class="p">:</span> <span class="n">batch_input_ids</span><span class="p">,</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="s2">&quot;responses&quot;</span><span class="p">:</span> <span class="n">batch_response_ids</span><span class="p">,</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>            <span class="s2">&quot;input_ids&quot;</span><span class="p">:</span> <span class="n">batch_seq</span><span class="p">,</span>  <span class="c1"># here input_ids become the whole sentences</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>            <span class="s2">&quot;attention_mask&quot;</span><span class="p">:</span> <span class="n">attention_mask</span><span class="p">,</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>            <span class="s2">&quot;position_ids&quot;</span><span class="p">:</span> <span class="n">position_ids</span><span class="p">,</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="s2">&quot;is_drop_mask&quot;</span><span class="p">:</span> <span class="n">is_drop_mask</span><span class="p">,</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="s2">&quot;token_level_scores&quot;</span><span class="p">:</span> <span class="n">token_level_scores</span><span class="o">.</span><span class="n">contiguous</span><span class="p">(),</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>        <span class="p">},</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>        <span class="n">batch_size</span><span class="o">=</span><span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>    <span class="p">)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>    <span class="n">data_proto</span> <span class="o">=</span> <span class="n">DataProto</span><span class="p">(</span><span class="n">batch</span><span class="o">=</span><span class="n">batch</span><span class="p">)</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>    <span class="n">data_metrics</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="s2">&quot;agent_mode/n_trunc_sample_because_of_response&quot;</span><span class="p">:</span> <span class="n">n_trunc_sample_because_of_response</span><span class="p">,</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="s2">&quot;agent_mode/n_sample_to_train&quot;</span><span class="p">:</span> <span class="n">n_transition</span><span class="p">,</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>    <span class="p">}</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>    <span class="c1"># Add non-tensor data for advantage calculation and logging</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>    <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;data_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data_id_list</span><span class="p">)</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>    <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;rollout_id_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rollout_id_list</span><span class="p">)</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>    <span class="n">data_proto</span><span class="o">.</span><span class="n">non_tensor_batch</span><span class="p">[</span><span class="s2">&quot;turn_index_list&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">turn_index_list</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>    <span class="k">return</span> <span class="n">data_proto</span><span class="p">,</span> <span class="n">data_metrics</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">run_until_all_finished</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.run_until_all_finished" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Synchronously waits for all queued tasks to be completed and reported.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-321" name="__codelineno-0-321"></a><span class="k">def</span><span class="w"> </span><span class="nf">run_until_all_finished</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronously waits for all queued tasks to be completed and reported.&quot;&quot;&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_tasks_queued</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: No tasks were queued.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="k">return</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>    <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_run_until_finished</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>  <span class="c1"># Wait indefinitely for all tasks to complete</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while waiting for tasks to finish: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">set_up_data_and_server</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.set_up_data_and_server" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Synchronous wrapper for setting up data and server resources.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-282" name="__codelineno-0-282"></a><span class="k">def</span><span class="w"> </span><span class="nf">set_up_data_and_server</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Synchronous wrapper for setting up data and server resources.&quot;&quot;&quot;</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Server is not running or ready.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="n">coro</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_async_set_up</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">server_addresses</span><span class="p">,</span> <span class="n">is_train</span><span class="p">)</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>    <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">coro</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">60</span><span class="p">)</span>  <span class="c1"># Wait for completion with a timeout</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to set up data on server: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="agentlightning.verl.AgentModeDaemon.start" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-method"></code>            <code class="highlight language-python"><span class="n">start</span><span class="p">()</span></code>

<a href="#agentlightning.verl.AgentModeDaemon.start" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Starts the main AgentLightningServer and the proxy server.</p>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-222" name="__codelineno-0-222"></a><span class="k">def</span><span class="w"> </span><span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Starts the main AgentLightningServer and the proxy server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">run_server</span><span class="p">():</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Run the AgentLightningServer in a separate thread.&quot;&quot;&quot;</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">asyncio</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">run_forever</span><span class="p">())</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">run_server</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_server_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="c1"># Wait for the server&#39;s internal startup event to be set.</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Waiting for AgentLightningServer to start...&quot;</span><span class="p">)</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>    <span class="n">is_ready</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">startup_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mf">20.0</span><span class="p">)</span>  <span class="c1"># Wait up to 20s</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ready</span><span class="p">:</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;AgentLightningServer failed to start within the timeout period.&quot;</span><span class="p">)</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AgentLightningServer control plane running on port </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">server_port</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>    <span class="bp">self</span><span class="o">.</span><span class="n">_start_proxy_server</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="agentlightning.verl.LLM" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>LLM</code>


<a href="#agentlightning.verl.LLM" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><a class="autorefs autorefs-internal" title="            Resource (agentlightning.types.Resource)" href="../core/#agentlightning.types.Resource">Resource</a></code></p>


        <p>Provide an LLM endpoint and model name as a resource.</p>


<p><span class="doc-section-title">Attributes:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td><code><span title="agentlightning.verl.LLM.endpoint">endpoint</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The URL of the LLM API endpoint.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="agentlightning.verl.LLM.model">model</span></code></td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The identifier for the model to be used (e.g., 'gpt-4o').</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td><code><span title="agentlightning.verl.LLM.sampling_parameters">sampling_parameters</span></code></td>
            <td>
                  <code><span title="SamplingParameters">SamplingParameters</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary of hyperparameters
for model inference, such as temperature, top_p, etc.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>








              <details class="quote">
                <summary>Source code in <code>agentlightning/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="k">class</span><span class="w"> </span><span class="nc">LLM</span><span class="p">(</span><span class="n">Resource</span><span class="p">):</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Provide an LLM endpoint and model name as a resource.</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    Attributes:</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        endpoint (str): The URL of the LLM API endpoint.</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a><span class="sd">        model (str): The identifier for the model to be used (e.g., &#39;gpt-4o&#39;).</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a><span class="sd">        sampling_parameters (SamplingParameters): A dictionary of hyperparameters</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a><span class="sd">            for model inference, such as temperature, top_p, etc.</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">resource_type</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;llm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;llm&quot;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>    <span class="n">endpoint</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">model</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="n">sampling_parameters</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="agentlightning.verl.Rollout" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-class"></code>            <code>Rollout</code>


<a href="#agentlightning.verl.Rollout" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>


        <p>The standard reporting object from client to server.</p>








              <details class="quote">
                <summary>Source code in <code>agentlightning/types.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="k">class</span><span class="w"> </span><span class="nc">Rollout</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;The standard reporting object from client to server.&quot;&quot;&quot;</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>    <span class="n">rollout_id</span><span class="p">:</span> <span class="nb">str</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>    <span class="c1"># Primary, high-level feedback</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="n">final_reward</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="c1"># Structured, sequential feedback for RL-style optimization</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="n">triplets</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Triplet</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>    <span class="c1"># Optional, rich-context data for deep analysis</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="n">trace</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A list of spans that conform to the OpenTelemetry JSON format. &quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="s2">&quot;Users of the opentelemetry-sdk can generate this by calling &quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="s2">&quot;json.loads(readable_span.to_json()).&quot;</span><span class="p">,</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="p">)</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>    <span class="n">logs</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>    <span class="c1"># A bucket for any other relevant information</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="n">metadata</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">












  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="agentlightning.verl.get_left_padded_ids_and_attention_mask" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">get_left_padded_ids_and_attention_mask</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">)</span></code>

<a href="#agentlightning.verl.get_left_padded_ids_and_attention_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Left-pad (or truncate) a sequence of token IDs to a fixed length,
and build the corresponding attention mask.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ids</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the original list of token IDs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>desired total length after padding/truncation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pad_token_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID to use for padding.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>padded_ids</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of length == max_length.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>attention_mask</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of same length: 1 for non-pad tokens, 0 for pads.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_left_padded_ids_and_attention_mask</span><span class="p">(</span><span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Left-pad (or truncate) a sequence of token IDs to a fixed length,</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">    and build the corresponding attention mask.</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        ids:             the original list of token IDs.</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        max_length:      desired total length after padding/truncation.</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        pad_token_id:    ID to use for padding.</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        padded_ids (any):      list of length == max_length.</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        attention_mask (any):  list of same length: 1 for non-pad tokens, 0 for pads.</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>    <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&gt;=</span> <span class="n">max_length</span><span class="p">:</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="c1"># too long → truncate from the left, keep the last max_length tokens</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="n">trimmed</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[</span><span class="o">-</span><span class="n">max_length</span><span class="p">:]</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_length</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">return</span> <span class="n">trimmed</span><span class="p">,</span> <span class="n">attention_mask</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>    <span class="c1"># too short → pad on the left</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>    <span class="n">pad_len</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="n">seq_len</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>    <span class="n">padded_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span> <span class="o">+</span> <span class="n">ids</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>    <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">seq_len</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">return</span> <span class="n">padded_ids</span><span class="p">,</span> <span class="n">attention_mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="agentlightning.verl.get_right_padded_ids_and_attention_mask" class="doc doc-heading">
<code class="doc-symbol doc-symbol-heading doc-symbol-function"></code>            <code class="highlight language-python"><span class="n">get_right_padded_ids_and_attention_mask</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">)</span></code>

<a href="#agentlightning.verl.get_right_padded_ids_and_attention_mask" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">

        <p>Right-pad (or truncate) a sequence of token IDs to a fixed length,
and build the corresponding attention mask.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>ids</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the original list of token IDs.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_length</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>desired total length after padding/truncation.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pad_token_id</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>ID to use for padding.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
<th>Name</th>          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
<td><code>padded_ids</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of length == max_length.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
<td><code>attention_mask</code></td>            <td>
                  <code><span title="any">any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>list of same length: 1 for non-pad tokens, 0 for pads.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>agentlightning/verl/daemon.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span>
<span class="normal"><a href="#__codelineno-0-77">77</a></span>
<span class="normal"><a href="#__codelineno-0-78">78</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="k">def</span><span class="w"> </span><span class="nf">get_right_padded_ids_and_attention_mask</span><span class="p">(</span><span class="n">ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">max_length</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">pad_token_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    Right-pad (or truncate) a sequence of token IDs to a fixed length,</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    and build the corresponding attention mask.</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        ids:            the original list of token IDs.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        max_length:     desired total length after padding/truncation.</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        pad_token_id:   ID to use for padding.</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        padded_ids (any):     list of length == max_length.</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        attention_mask (any): list of same length: 1 for non-pad tokens, 0 for pads.</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">seq_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids</span><span class="p">)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="k">if</span> <span class="n">seq_len</span> <span class="o">&gt;=</span> <span class="n">max_length</span><span class="p">:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="c1"># too long → truncate to the first max_length tokens</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">trimmed</span> <span class="o">=</span> <span class="n">ids</span><span class="p">[:</span><span class="n">max_length</span><span class="p">]</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">max_length</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="k">return</span> <span class="n">trimmed</span><span class="p">,</span> <span class="n">attention_mask</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="c1"># too short → pad on the right</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">pad_len</span> <span class="o">=</span> <span class="n">max_length</span> <span class="o">-</span> <span class="n">seq_len</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="n">padded_ids</span> <span class="o">=</span> <span class="n">ids</span> <span class="o">+</span> <span class="p">[</span><span class="n">pad_token_id</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>    <span class="n">attention_mask</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">seq_len</span> <span class="o">+</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">pad_len</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">return</span> <span class="n">padded_ids</span><span class="p">,</span> <span class="n">attention_mask</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>







  
    
  
  
    
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="August 10, 2025 06:44:00 UTC"><span class="timeago" datetime="2025-08-10T06:44:00+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="August 10, 2025 06:44:00 UTC">2025-08-10</span>
  </span>

    
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Created">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.47 15.08 11 13V7h1.5v5.25l3.08 1.83c-.41.28-.79.62-1.11 1m-1.39 4.84c-.36.05-.71.08-1.08.08-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8c0 .37-.03.72-.08 1.08.69.1 1.33.32 1.92.64.1-.56.16-1.13.16-1.72 0-5.5-4.5-10-10-10S2 6.5 2 12s4.47 10 10 10c.59 0 1.16-.06 1.72-.16-.32-.59-.54-1.23-.64-1.92M18 15v3h-3v2h3v3h2v-3h3v-2h-3v-3z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-timeago" title="August 10, 2025 06:44:00 UTC"><span class="timeago" datetime="2025-08-10T06:44:00+00:00" locale="en"></span></span><span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_date" title="August 10, 2025 06:44:00 UTC">2025-08-10</span>
  </span>

    
    
      
  
  <span class="md-source-file__fact">
    <span class="md-icon" title="Contributors">
      
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4a4 4 0 0 1 4 4 4 4 0 0 1-4 4 4 4 0 0 1-4-4 4 4 0 0 1 4-4m0 10c4.42 0 8 1.79 8 4v2H4v-2c0-2.21 3.58-4 8-4"/></svg>
      
    </span>
    <nav>
      
        <a href="mailto:yuge.zhang@microsoft.com">Yuge Zhang</a>
    </nav>
  </span>

    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.sections", "navigation.expand", "navigation.top", "search.suggest", "search.highlight", "content.code.copy"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": {"default": "latest", "provider": "mike"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
        <script src="../../js/timeago.min.js"></script>
      
        <script src="../../js/timeago_mkdocs_material.js"></script>
      
        <script src="https://unpkg.com/mermaid@10.6.1/dist/mermaid.min.js"></script>
      
        <script src="../../js/favicon-theme.js"></script>
      
    
  </body>
</html>